<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Editor - Macros POS LOL</title>
    <link rel="stylesheet" href="styles.css">
    <style>        body {
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 0;
            background: #f8fafc;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        .menu-editor-container {
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
        }        .editor-header {
            background: white;
            border: 2px solid #000;
            border-top: none;
            border-left: none;
            border-right: none;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .editor-title {
            font-size: 2rem;
            font-weight: bold;
            color: #1f2937;
            margin: 0;
        }

        .cloud-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: #f9fafb;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .cloud-status.connected {
            border-color: #10b981;
            background: #ecfdf5;
            color: #059669;
        }

        .cloud-status.offline {
            border-color: #f59e0b;
            background: #fffbeb;
            color: #d97706;
        }

        .cloud-status.error {
            border-color: #ef4444;
            background: #fef2f2;
            color: #dc2626;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .back-button, .save-button {
            background: #3b82f6;
            color: white;
            border: 2px solid #000;
            padding: 0.75rem 1.5rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .save-button {
            background: #10b981;
        }

        .back-button:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }

        .save-button:hover {
            background: #059669;
            transform: translateY(-2px);
        }        .editor-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 1.5rem;
            padding: 1.5rem;
            flex: 1;
            overflow: hidden;
        }.menu-list-panel {
            background: white;
            border: 2px solid #000;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .panel-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
        }

        .add-item-btn {
            background: #10b981;
            color: white;
            border: 2px solid #000;
            padding: 0.75rem 1.5rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-item-btn:hover {
            background: #059669;
            transform: translateY(-2px);
        }
        
        .menu-items-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            flex: 1;
            overflow-y: auto;
        }

        .menu-item-card {
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            padding: 1.5rem;
            transition: all 0.2s;
            cursor: pointer;
        }

        .menu-item-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
        }

        .menu-item-card.selected {
            background: #dbeafe;
            border-color: #3b82f6;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .item-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: #1f2937;
        }

        .item-price {
            font-size: 1.1rem;
            font-weight: bold;
            color: #059669;
        }

        .item-description {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .item-btn {
            background: #f1f5f9;
            color: #4a5568;
            border: 1px solid #e2e8f0;
            padding: 0.5rem 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .item-btn:hover {
            background: #e2e8f0;
            border-color: #cbd5e0;
        }

        .item-btn.edit {
            background: #3b82f6;
            color: white;
            border-color: #2563eb;
        }

        .item-btn.edit:hover {
            background: #2563eb;
        }        .item-btn.delete {
            background: #ef4444;
            color: white;
            border-color: #dc2626;
        }

        .item-btn.delete:hover {
            background: #dc2626;
        }

        .item-btn.eighty-six {
            background: #f59e0b;
            color: white;
            border-color: #d97706;
        }

        .item-btn.eighty-six:hover {
            background: #d97706;
        }

        .item-btn.eighty-six.active {
            background: #dc2626;
            border-color: #b91c1c;
        }

        /* 86'd Item Styling */
        .menu-item-card.eighty-sixed {
            position: relative;
            opacity: 0.7;
            background: repeating-linear-gradient(
                45deg,
                #f8fafc,
                #f8fafc 8px,
                #f1f5f9 8px,
                #f1f5f9 16px
            );
        }

        .menu-item-card.eighty-sixed::before {
            content: '86\'D';
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc2626;
            color: white;
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
            font-weight: bold;
            border-radius: 4px;
            z-index: 1;
        }

        .eighty-six-controls {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .eighty-six-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .eighty-six-title {
            font-weight: bold;
            color: #92400e;
            font-size: 1.1rem;
        }

        .bulk-eighty-six {
            background: #f59e0b;
            color: white;
            border: 2px solid #d97706;
            padding: 0.5rem 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            cursor: pointer;
            border-radius: 4px;
        }

        .bulk-eighty-six:hover {
            background: #d97706;
        }

        .day-availability {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .day-toggle {
            background: #10b981;
            color: white;
            border: 2px solid #059669;
            padding: 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            cursor: pointer;
            text-align: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .day-toggle.disabled {
            background: #ef4444;
            border-color: #dc2626;
        }

        .day-toggle:hover {
            transform: translateY(-1px);
        }

        .eighty-six-stats {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
            padding: 1rem;
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
        }

        .stat-item {
            text-align: center;
            flex: 1;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #1f2937;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6b7280;
        }

        .available-count {
            color: #10b981;
        }

        .eighty-sixed-count {
            color: #ef4444;
        }.item-editor-panel {
            background: white;
            border: 2px solid #000;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            background: white;
            border: 2px solid #000;
            padding: 0.75rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            box-sizing: border-box;
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-checkbox {
            width: auto;
            margin-right: 0.5rem;
        }

        .emoji-picker {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 0.5rem;
            margin-top: 0.5rem;
            padding: 1rem;
            background: #f8fafc;
            border: 2px solid #e5e7eb;
        }

        .emoji-option {
            background: white;
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
            text-align: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }

        .emoji-option:hover {
            background: #e2e8f0;
            border-color: #cbd5e0;
        }

        .emoji-option.selected {
            background: #3b82f6;
            color: white;
            border-color: #2563eb;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .form-btn {
            flex: 1;
            background: #f1f5f9;
            color: #4a5568;
            border: 2px solid #000;
            padding: 0.75rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .form-btn.primary {
            background: #10b981;
            color: white;
        }

        .form-btn.primary:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .form-btn.secondary:hover {
            background: #e2e8f0;
            transform: translateY(-2px);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 1rem 1.5rem;
            border: 2px solid #000;
            z-index: 1000;
            font-weight: bold;
            animation: slideIn 0.3s ease;
        }

        .notification.warning {
            background: #f59e0b;
        }

        .notification.error {
            background: #ef4444;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .search-filter {
            margin-bottom: 1rem;
        }

        .search-input {
            width: 100%;
            background: white;
            border: 2px solid #000;
            padding: 0.75rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            box-sizing: border-box;
        }

        .category-filter {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .category-btn {
            background: #f1f5f9;
            color: #4a5568;
            border: 1px solid #e2e8f0;
            padding: 0.5rem 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-btn:hover {
            background: #e2e8f0;
            border-color: #cbd5e0;
        }

        .category-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #2563eb;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #9ca3af;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        /* Modifier Styles */
        .modifier-tab-btn {
            background: #3b82f6;
            color: white;
            border: 2px solid #2563eb;
            padding: 0.75rem 1.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 4px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .modifier-tab-btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }
        
        .modifiers-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .modifiers-modal {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .modifiers-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .modifiers-modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .modifiers-modal-content {
            padding: 1.5rem;
        }
        
        .modifiers-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding: 1.5rem;
            border-top: 2px solid #e5e7eb;
        }
        
        .modifiers-group {
            background: #f9fafb;
            border: 2px solid #e7e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .modifiers-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .modifiers-group-title {
            font-weight: 600;
            color: #374151;
        }
        
        .modifiers-group-type {
            display: flex;
            gap: 0.5rem;
        }
        
        .modifier-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .modifier-option:last-child {
            border-bottom: none;
        }
        
        .modifier-add-btn {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
        }
        
        .modifier-add-btn:hover {
            background: #059669;
        }
        
        .modifier-remove-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
        }
          .modifier-remove-btn:hover {
            background: #dc2626;
        }
        
        .modifier-move-btn {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            margin-right: 4px;
        }
        
        .modifier-move-btn:hover {
            background: #2563eb;
        }
        
        .modifier-move-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }
        
        .modifier-move-btn-small {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .modifier-move-btn-small:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }
        
        .add-group-btn {
            background: #f3f4f6;
            border: 2px dashed #d1d5db;
            color: #4b5563;
            width: 100%;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .add-group-btn:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
        }
        
        .modifiers-badge {
            background: #3b82f6;
            color: white;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            margin-left: 0.5rem;
        }
        
        @media (max-width: 768px) {
            .editor-layout {
                grid-template-columns: 1fr;
                gap: 1rem;
                padding: 1rem;
            }
            
            .editor-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="menu-editor-container">
        <header class="editor-header">
            <div class="header-left">
                <h1 class="editor-title">🍽️ Menu Editor</h1>
                <div id="cloudStatus" class="cloud-status">
                    <span id="cloudStatusIcon">🔄</span>
                    <span id="cloudStatusText">Connecting...</span>
                </div>
            </div>
            <div class="header-actions">
                <input type="file" id="menuImportInput" accept=".json,.csv" style="display:none" />
                <button class="back-button" onclick="document.getElementById('menuImportInput').click()">📁 Import Menu</button>
                <button class="back-button" onclick="exportMenu()">📤 Export Menu</button>
                <a href="settings.html" class="back-button">← Back to Settings</a>
                <button class="save-button" onclick="saveAllChanges()">💾 Save Changes</button>
            </div>
        </header>

        <div class="editor-layout">
            <!-- Menu Items List -->
            <div class="menu-list-panel">
                <div class="panel-header">
                    <h2 class="panel-title">Menu Items</h2>
                    <button class="add-item-btn" onclick="addNewItem()">+ Add Item</button>
                </div>                <!-- Search and Filter -->
                <div class="search-filter">
                    <input type="text" class="search-input" placeholder="Search menu items..." onkeyup="filterItems()" id="searchInput">
                </div>

                <!-- 86 Controls -->
                <div class="eighty-six-controls">
                    <div class="eighty-six-header">
                        <span class="eighty-six-title">🚫 86 Controls</span>
                        <button class="bulk-eighty-six" onclick="toggleBulkEightySix()">Bulk 86</button>
                    </div>
                    <div class="eighty-six-stats">
                        <div class="stat-item">
                            <div class="stat-number available-count" id="availableCount">0</div>
                            <div class="stat-label">Available</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number eighty-sixed-count" id="eightySixedCount">0</div>
                            <div class="stat-label">86'd Today</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="totalCount">0</div>
                            <div class="stat-label">Total Items</div>
                        </div>
                    </div>
                </div>

                <div class="category-filter">
                    <button class="category-btn active" onclick="filterByCategory('all')">All</button>
                    <button class="category-btn" onclick="filterByCategory('appetizers')">Appetizers</button>
                    <button class="category-btn" onclick="filterByCategory('mains')">Main Courses</button>
                    <button class="category-btn" onclick="filterByCategory('desserts')">Desserts</button>
                    <button class="category-btn" onclick="filterByCategory('beverages')">Beverages</button>
                </div>

                <!-- Menu Items List -->
                <div class="menu-items-list" id="menuItemsList">
                    <!-- Menu items will be populated by JavaScript -->
                </div>
            </div>

            <!-- Item Editor Panel -->
            <div class="item-editor-panel">
                <div class="panel-header">
                    <h3 class="panel-title" id="editorTitle">Add New Item</h3>
                </div>

                <form id="itemForm">
                    <div class="form-group">
                        <label class="form-label" for="itemName">Item Name</label>
                        <input type="text" class="form-input" id="itemName" placeholder="Enter item name" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="itemPrice">Price ($)</label>
                        <input type="number" class="form-input" id="itemPrice" placeholder="0.00" step="0.01" min="0" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="itemCategory">Category</label>
                        <select class="form-select" id="itemCategory" required>
                            <option value="">Select category</option>
                            <option value="appetizers">Appetizers</option>
                            <option value="mains">Main Courses</option>
                            <option value="desserts">Desserts</option>
                            <option value="beverages">Beverages</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="itemDescription">Description</label>
                        <textarea class="form-textarea" id="itemDescription" placeholder="Enter item description"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Item Icon</label>
                        <div class="emoji-picker" id="emojiPicker">
                            <div class="emoji-option" data-emoji="🍔" onclick="selectEmoji('🍔')">🍔</div>
                            <div class="emoji-option" data-emoji="🍕" onclick="selectEmoji('🍕')">🍕</div>
                            <div class="emoji-option" data-emoji="🥗" onclick="selectEmoji('🥗')">🥗</div>
                            <div class="emoji-option" data-emoji="🍝" onclick="selectEmoji('🍝')">🍝</div>
                            <div class="emoji-option" data-emoji="🥩" onclick="selectEmoji('🥩')">🥩</div>
                            <div class="emoji-option" data-emoji="☕" onclick="selectEmoji('☕')">☕</div>
                            <div class="emoji-option" data-emoji="🍰" onclick="selectEmoji('🍰')">🍰</div>
                            <div class="emoji-option" data-emoji="🍷" onclick="selectEmoji('🍷')">🍷</div>
                            <div class="emoji-option" data-emoji="🍺" onclick="selectEmoji('🍺')">🍺</div>
                            <div class="emoji-option" data-emoji="🥤" onclick="selectEmoji('🥤')">🥤</div>
                            <div class="emoji-option" data-emoji="🍜" onclick="selectEmoji('🍜')">🍜</div>
                            <div class="emoji-option" data-emoji="🌮" onclick="selectEmoji('🌮')">🌮</div>
                            <div class="emoji-option" data-emoji="🍣" onclick="selectEmoji('🍣')">🍣</div>
                            <div class="emoji-option" data-emoji="🥪" onclick="selectEmoji('🥪')">🥪</div>
                            <div class="emoji-option" data-emoji="🍪" onclick="selectEmoji('🍪')">🍪</div>
                        </div>
                        <input type="hidden" id="selectedEmoji" value="">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Modifiers</label>
                        <div class="modifiers-container">
                            <button type="button" class="modifier-tab-btn" onclick="showModifiersPanel()">
                                ✏️ Configure Item Modifiers
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Available</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="itemAvailable" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Day-Specific Availability</label>
                        <div class="day-availability">
                            <button type="button" class="day-toggle" data-day="monday" onclick="toggleDayAvailability('monday')">Mon</button>
                            <button type="button" class="day-toggle" data-day="tuesday" onclick="toggleDayAvailability('tuesday')">Tue</button>
                            <button type="button" class="day-toggle" data-day="wednesday" onclick="toggleDayAvailability('wednesday')">Wed</button>
                            <button type="button" class="day-toggle" data-day="thursday" onclick="toggleDayAvailability('thursday')">Thu</button>
                            <button type="button" class="day-toggle" data-day="friday" onclick="toggleDayAvailability('friday')">Fri</button>
                            <button type="button" class="day-toggle" data-day="saturday" onclick="toggleDayAvailability('saturday')">Sat</button>
                            <button type="button" class="day-toggle" data-day="sunday" onclick="toggleDayAvailability('sunday')">Sun</button>
                        </div>
                        <p style="font-size: 0.8rem; color: #6b7280; margin-top: 0.5rem;">
                            Click days to toggle availability. Red = 86'd (unavailable)
                        </p>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="form-btn secondary" onclick="clearForm()">Clear</button>
                        <button type="submit" class="form-btn primary" id="saveBtn">Save Item</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modifiers Modal -->
        <div class="modifiers-modal-overlay" id="modifiersModal" style="display: none;">
            <div class="modifiers-modal">
                <div class="modifiers-modal-header">
                    <h3 class="modifiers-modal-title">🛠️ Configure Item Modifiers</h3>
                    <button class="modal-close" onclick="closeModifiersPanel()">&times;</button>
                </div>
                <div class="modifiers-modal-content">
                    <div id="modifierGroupsContainer">
                        <!-- Modifier groups will be dynamically added here -->
                    </div>
                    
                    <button class="add-group-btn" onclick="addModifierGroup()">
                        <span>+</span> Add Modifier Group
                    </button>
                </div>
                <div class="modifiers-modal-footer">
                    <button type="button" class="form-btn secondary" onclick="closeModifiersPanel()">Cancel</button>
                    <button type="button" class="form-btn primary" onclick="saveModifiers()">Save Modifiers</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="js/firebase-config.js?v=20250627004"></script>
    
    <!-- Firebase Manager -->
    <script src="js/firebase-manager.js?v=20250627004"></script>
    
    <!-- Umbrella Account Manager -->
    <script src="js/umbrella-account-manager.js?v=20250627004"></script>

    <script>        // Menu items data - initialized empty for fresh start
        let menuItems = [];

        let currentEditingItem = null;
        let currentFilter = 'all';
        // Default modifier groups that can be used
        const defaultModifierGroups = [
            {
                name: "Cooking Temperature",
                type: "single",
                options: ["Rare", "Medium Rare", "Medium", "Medium Well", "Well Done"]
            },
            {
                name: "Add/Remove Ingredients",
                type: "multi",
                options: ["Extra Cheese", "No Cheese", "Extra Sauce", "No Sauce", "Add Bacon", "Add Avocado"]
            },
            {
                name: "Bread/Bun Type",
                type: "single",
                options: ["White Bun", "Wheat Bun", "Brioche Bun", "Gluten-Free Bun", "Lettuce Wrap"]
            },
            {
                name: "Cheese Options",
                type: "single",
                options: ["American", "Swiss", "Cheddar", "Pepper Jack", "Blue Cheese", "No Cheese"]
            },
            {
                name: "Side Choices",
                type: "single", 
                options: ["French Fries", "Onion Rings", "Side Salad", "Sweet Potato Fries", "Fruit Cup"]
            },
            {
                name: "Egg Styles",
                type: "single",
                options: ["Sunny Side Up", "Over Easy", "Over Medium", "Over Hard", "Scrambled", "Poached"]
            },
            {
                name: "Spice Level",
                type: "single",
                options: ["Mild", "Medium", "Hot", "Extra Hot"]
            },
            {
                name: "Sauces/Condiments",
                type: "multi",
                options: ["Ketchup", "Mustard", "Mayo", "BBQ Sauce", "Hot Sauce", "Ranch", "Aioli"]
            },
            {
                name: "Dairy Options",
                type: "single",
                options: ["Whole Milk", "Skim Milk", "Oat Milk", "Almond Milk", "Soy Milk", "Coconut Milk", "No Milk"]
            },
            {
                name: "Dietary Tags",
                type: "multi", 
                options: ["Gluten-Free", "Vegan", "Vegetarian", "Dairy-Free", "Nut-Free", "Keto-Friendly"]
            }
        ];        // Initialize the menu editor
        document.addEventListener('DOMContentLoaded', async function() {
            // Clear any existing demo data from localStorage
            // localStorage.removeItem('menuItems'); // Commented out to preserve data
            
            // Wait for Firebase to initialize
            await initializeMenuEditor();
            
            initializeDayAvailability();
            initializeMenuImport(); // Initialize import functionality
            
            // Set up periodic business context checking if Firebase is available but no context found
            setupBusinessContextWatcher();
        });
        
        // Set up a watcher for business context changes
        function setupBusinessContextWatcher() {
            // Only set up watcher if Firebase is available but no business context was found
            if (window.firebaseServices && window.firebaseServices.getDb()) {
                const currentStatus = document.getElementById('cloudStatusText').textContent;
                if (currentStatus.includes('No business context') || currentStatus.includes('No business selected')) {
                    console.log('Setting up business context watcher...');
                    
                    // Check every 5 seconds for business context changes
                    const contextWatcher = setInterval(async () => {
                        console.log('Checking for business context...');
                        const hasContext = await checkForBusinessContext();
                        if (hasContext) {
                            console.log('Business context found! Re-initializing Firebase connection...');
                            clearInterval(contextWatcher);
                            
                            // Re-check Firebase connection and potentially reload from cloud
                            const isConnected = await checkFirebaseConnection();
                            if (isConnected && menuItems.length === 0) {
                                // Try to load from Firebase if we haven't loaded anything yet
                                const firebaseLoaded = await loadMenuFromFirebase();
                                if (firebaseLoaded) {
                                    renderMenuItems();
                                }
                            }
                        }
                    }, 5000);
                    
                    // Stop checking after 2 minutes
                    setTimeout(() => {
                        clearInterval(contextWatcher);
                        console.log('Business context watcher stopped');
                    }, 120000);
                }
            }
        }
        
        // Check if business context is available
        async function checkForBusinessContext() {
            // Check umbrella manager
            if (window.umbrellaManager && window.umbrellaManager.currentBusiness) {
                return true;
            }
            
            // Check super admin
            if (window.SuperAdminManager) {
                try {
                    const context = window.SuperAdminManager.getCurrentBusinessContext();
                    if (context && context.businessID) {
                        return true;
                    }
                } catch (e) {
                    // Ignore error
                }
            }
            
            // Check localStorage
            const storedContext = localStorage.getItem('currentBusinessContext');
            if (storedContext) {
                try {
                    const contextData = JSON.parse(storedContext);
                    if (contextData.businessID || contextData.id) {
                        return true;
                    }
                } catch (e) {
                    // Ignore error
                }
            }
            
            return false;
        }
        
        // Initialize menu editor with Firebase integration
        async function initializeMenuEditor() {
            try {
                // Wait a bit for Firebase services to load
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Check Firebase connection first
                console.log('Checking Firebase connection...');
                const isConnected = await checkFirebaseConnection();
                console.log('Firebase connection result:', isConnected);
                
                // Load menu data (Firebase first if connected, then localStorage fallback)
                await loadMenuData();
                
                // Re-check connection status after loading
                if (isConnected) {
                    console.log('Firebase is connected, checking if menu was loaded from cloud...');
                    // If we have business context and Firebase is available, update status to connected
                    await checkFirebaseConnection();
                }
                
                console.log('Menu editor initialized successfully');
            } catch (error) {
                console.error('Error initializing menu editor:', error);
                updateCloudStatus('error', 'Initialization failed');
                // Fallback to localStorage only
                loadMenuFromLocalStorage();
                renderMenuItems();
            }
        }        // Get property context for storage
        function getPropertyContext() {
            try {
                // Check for current business context first
                const businessContext = localStorage.getItem('currentBusinessContext');
                if (businessContext) {
                    return JSON.parse(businessContext);
                }
                
                // Check for current property context
                const propertyContext = localStorage.getItem('currentPropertyContext');
                if (propertyContext) {
                    return JSON.parse(propertyContext);
                }
                
                // Check for selected property information
                const selectedProperty = localStorage.getItem('selectedProperty');
                if (selectedProperty) {
                    return JSON.parse(selectedProperty);
                }
            } catch (error) {
                console.error("Error getting property context:", error);
            }
            
            return null;
        }

        // Generate unique ID for menu items
        function generateUniqueId() {
            return 'item_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Load menu data from Firebase cloud storage first, then fallback to localStorage
        async function loadMenuData() {
            try {
                console.log('Loading menu data...');
                
                // First try to load from Firebase
                const firebaseMenuLoaded = await loadMenuFromFirebase();
                
                if (!firebaseMenuLoaded) {
                    // Fallback to localStorage
                    loadMenuFromLocalStorage();
                }
                
                // Ensure all items have unique IDs
                menuItems = menuItems.map((item, index) => {
                    if (!item.id) {
                        item.id = generateUniqueId();
                    }
                    return item;
                });
                
                console.log('Final loaded menuItems:', menuItems.length, 'items');
                if (menuItems.length > 0) {
                    console.log('Sample item structure:', menuItems[0]);
                }
                
                renderMenuItems();
                
            } catch (error) {
                console.error("Error loading menu data:", error);
                // Final fallback to localStorage
                loadMenuFromLocalStorage();
                renderMenuItems();
            }
        }

        // Load menu from Firebase via umbrella account system
        async function loadMenuFromFirebase() {
            try {
                // Check if Firebase services are available
                if (!window.firebaseServices) {
                    console.log("Firebase services not available - using localStorage");
                    updateCloudStatus('offline', 'Firebase not available');
                    return false;
                }

                const db = window.firebaseServices.getDb();
                if (!db) {
                    console.log("Firebase database not available - using localStorage");
                    updateCloudStatus('offline', 'Database not available');
                    return false;
                }

                // Get current business context from multiple sources
                let currentBusiness = null;
                let businessSource = 'none';

                // 1. Try umbrella manager first
                if (window.umbrellaManager && window.umbrellaManager.currentBusiness) {
                    currentBusiness = window.umbrellaManager.currentBusiness;
                    businessSource = 'umbrella_manager';
                    console.log('Found business context from umbrella manager:', currentBusiness.companyName);
                }

                // 2. Try super admin business context
                if (!currentBusiness && window.SuperAdminManager) {
                    try {
                        const superAdminContext = window.SuperAdminManager.getCurrentBusinessContext();
                        if (superAdminContext && superAdminContext.businessID) {
                            currentBusiness = {
                                id: superAdminContext.businessID,
                                companyName: superAdminContext.companyName || 'Super Admin Business'
                            };
                            businessSource = 'super_admin';
                            console.log('Found business context from super admin:', currentBusiness.companyName);
                        }
                    } catch (e) {
                        console.warn('Error getting super admin context:', e.message);
                    }
                }

                // 3. Try localStorage business context
                if (!currentBusiness) {
                    const storedContext = localStorage.getItem('currentBusinessContext');
                    if (storedContext) {
                        try {
                            const contextData = JSON.parse(storedContext);
                            if (contextData.businessID || contextData.id) {
                                currentBusiness = {
                                    id: contextData.businessID || contextData.id,
                                    companyName: contextData.companyName || contextData.businessName || 'Current Business'
                                };
                                businessSource = 'localStorage';
                                console.log('Found business context from localStorage:', currentBusiness.companyName);
                            }
                        } catch (e) {
                            console.warn('Failed to parse business context from localStorage');
                        }
                    }
                }

                if (!currentBusiness || !currentBusiness.id) {
                    console.log("No current business context available - using localStorage");
                    updateCloudStatus('offline', 'No business selected');
                    return false;
                }

                const businessId = currentBusiness.id;
                console.log(`Loading menu from Firebase for business: ${businessId} (source: ${businessSource})`);
                
                // Test Firebase connection first
                try {
                    await db.collection('businesses').doc(businessId).get();
                    console.log('Firebase connection verified');
                } catch (connectionError) {
                    console.error('Firebase connection test failed:', connectionError);
                    updateCloudStatus('error', 'Connection failed');
                    return false;
                }
                
                // Load menu from Firebase
                const menuDoc = await db.collection('menus').doc(`${businessId}_restaurant`).get();
                
                if (menuDoc.exists) {
                    const menuData = menuDoc.data();
                    menuItems = menuData.items || [];
                    console.log(`✅ Menu loaded from Firebase for business: ${businessId} (${menuItems.length} items)`);
                    updateCloudStatus('connected', `Connected to ${currentBusiness.companyName} (${businessSource})`);
                    showNotification(`Menu loaded from cloud (${menuItems.length} items)`, 'success');
                    return true;
                } else {
                    console.log("No menu found in Firebase for this business - using localStorage");
                    updateCloudStatus('connected', `Connected to ${currentBusiness.companyName} (${businessSource}) - No cloud menu`);
                    return false;
                }
                
            } catch (error) {
                console.error("Error loading menu from Firebase:", error);
                updateCloudStatus('error', 'Load failed');
                showNotification('Could not load from cloud, using local data', 'warning');
                return false;
            }
        }

        // Load menu from localStorage (fallback)
        function loadMenuFromLocalStorage() {
            try {
                // Get current property context for backward compatibility
                const propertyContext = getPropertyContext();
                
                if (propertyContext && propertyContext.id) {
                    // Load from property-specific storage
                    const propertyMenuKey = `property_${propertyContext.id}_menu`;
                    const savedMenu = localStorage.getItem(propertyMenuKey);
                    
                    if (savedMenu) {
                        menuItems = JSON.parse(savedMenu);
                        console.log(`Loaded menu data for property: ${propertyContext.name} (ID: ${propertyContext.id})`);
                        
                        // Check if Firebase is available but business context is missing
                        if (window.firebaseServices && window.firebaseServices.getDb()) {
                            updateCloudStatus('offline', 'Firebase ready - No business context');
                        } else {
                            updateCloudStatus('offline', 'Using local data');
                        }
                        return;
                    }
                }
                
                // Try uploaded menu data
                const uploadedMenu = localStorage.getItem('menuData');
                if (uploadedMenu) {
                    menuItems = JSON.parse(uploadedMenu);
                    console.log("Loaded menu data from uploaded menu (menuData)");
                    
                    // Check if Firebase is available but business context is missing
                    if (window.firebaseServices && window.firebaseServices.getDb()) {
                        updateCloudStatus('offline', 'Firebase ready - No business context');
                    } else {
                        updateCloudStatus('offline', 'Using local data');
                    }
                    return;
                }
                
                // Try global storage
                const globalMenu = localStorage.getItem('menuItems');
                if (globalMenu) {
                    menuItems = JSON.parse(globalMenu);
                    console.log("Loaded menu data from global storage");
                    
                    // Check if Firebase is available but business context is missing
                    if (window.firebaseServices && window.firebaseServices.getDb()) {
                        updateCloudStatus('offline', 'Firebase ready - No business context');
                    } else {
                        updateCloudStatus('offline', 'Using local data');
                    }
                    return;
                }
                
                // No menu data found
                menuItems = [];
                console.log("No menu data found in localStorage - starting with empty menu");
                
                // Check if Firebase is available but business context is missing
                if (window.firebaseServices && window.firebaseServices.getDb()) {
                    updateCloudStatus('offline', 'Firebase ready - No business context');
                } else {
                    updateCloudStatus('offline', 'No menu data');
                }
                
            } catch (error) {
                console.error("Error loading menu from localStorage:", error);
                menuItems = [];
                updateCloudStatus('error', 'Load error');
            }
        }

        // Save menu data to Firebase cloud storage via umbrella account system
        async function saveMenuData() {
            try {
                // Save to Firebase first (cloud storage)
                await saveMenuToFirebase();
                
                // Keep localStorage as backup/cache for offline access
                saveMenuToLocalStorage();
                
                console.log("Menu data saved to cloud and local storage");
                
            } catch (error) {
                console.error("Error saving menu data:", error);
                // Fallback to localStorage only if Firebase fails
                saveMenuToLocalStorage();
            }
        }

        // Save menu to Firebase via umbrella account system
        async function saveMenuToFirebase() {
            try {
                // Check if Firebase services are available
                if (!window.firebaseServices) {
                    console.warn("Firebase services not available");
                    updateCloudStatus('offline', 'Firebase not available');
                    return;
                }

                const db = window.firebaseServices.getDb();
                if (!db) {
                    console.warn("Firebase database not available");
                    updateCloudStatus('offline', 'Database not available');
                    return;
                }

                // Get current business context from multiple sources
                let currentBusiness = null;
                let businessSource = 'none';

                // 1. Try umbrella manager first
                if (window.umbrellaManager && window.umbrellaManager.currentBusiness) {
                    currentBusiness = window.umbrellaManager.currentBusiness;
                    businessSource = 'umbrella_manager';
                }

                // 2. Try super admin business context
                if (!currentBusiness && window.SuperAdminManager) {
                    try {
                        const superAdminContext = window.SuperAdminManager.getCurrentBusinessContext();
                        if (superAdminContext && superAdminContext.businessID) {
                            currentBusiness = {
                                id: superAdminContext.businessID,
                                companyName: superAdminContext.companyName || 'Super Admin Business'
                            };
                            businessSource = 'super_admin';
                        }
                    } catch (e) {
                        console.warn('Error getting super admin context:', e.message);
                    }
                }

                // 3. Try localStorage business context
                if (!currentBusiness) {
                    const storedContext = localStorage.getItem('currentBusinessContext');
                    if (storedContext) {
                        try {
                            const contextData = JSON.parse(storedContext);
                            if (contextData.businessID || contextData.id) {
                                currentBusiness = {
                                    id: contextData.businessID || contextData.id,
                                    companyName: contextData.companyName || contextData.businessName || 'Current Business'
                                };
                                businessSource = 'localStorage';
                            }
                        } catch (e) {
                            console.warn('Failed to parse business context from localStorage');
                        }
                    }
                }

                if (!currentBusiness || !currentBusiness.id) {
                    console.warn("No current business context available");
                    updateCloudStatus('offline', 'No business selected');
                    return;
                }

                const businessId = currentBusiness.id;
                console.log(`Saving menu to Firebase for business: ${businessId} (source: ${businessSource})`);
                
                // Save menu to Firebase under the business's restaurant menu
                const menuData = {
                    businessId: businessId,
                    menuType: 'restaurant',
                    items: menuItems,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    isActive: true,
                    editorVersion: '2.0',
                    totalItems: menuItems.length
                };

                await db.collection('menus').doc(`${businessId}_restaurant`).set(menuData);
                console.log(`✅ Menu successfully saved to Firebase for business: ${businessId}`);
                
                updateCloudStatus('connected', `Connected to ${currentBusiness.companyName} (${businessSource})`);
                showNotification('Menu saved to cloud successfully!', 'success');
                
            } catch (error) {
                console.error("Error saving menu to Firebase:", error);
                updateCloudStatus('error', 'Save failed');
                showNotification('Failed to save to cloud, saved locally instead', 'warning');
                throw error;
            }
        }

        // Save menu to localStorage (backup/cache)
        function saveMenuToLocalStorage() {
            try {
                // Get current property context for backward compatibility
                const propertyContext = getPropertyContext();
                
                if (propertyContext && propertyContext.id) {
                    // Save to property-specific storage
                    const propertyMenuKey = `property_${propertyContext.id}_menu`;
                    localStorage.setItem(propertyMenuKey, JSON.stringify(menuItems));
                    console.log(`Menu saved to property storage: ${propertyContext.name} (ID: ${propertyContext.id})`);
                } else {
                    // Fallback to global storage if no property context
                    localStorage.setItem('menuItems', JSON.stringify(menuItems));
                    console.log("Menu saved to global localStorage");
                }
                
                // Also save to menuData for sync with POS interface
                localStorage.setItem('menuData', JSON.stringify(menuItems));
                
            } catch (error) {
                console.error("Error saving menu to localStorage:", error);
                // Final fallback
                localStorage.setItem('menuItems', JSON.stringify(menuItems));
                localStorage.setItem('menuData', JSON.stringify(menuItems));
            }
        }

        // Render menu items list
        function renderMenuItems() {
            console.log('renderMenuItems called, menuItems length:', menuItems.length);
            
            const menuList = document.getElementById('menuItemsList');
            if (!menuList) {
                console.error('menuItemsList element not found!');
                return;
            }
            
            // Ensure all items have IDs before rendering
            let idsAdded = 0;
            menuItems = menuItems.map((item, index) => {
                if (!item.id) {
                    item.id = generateUniqueId();
                    idsAdded++;
                }
                return item;
            });
            
            if (idsAdded > 0) {
                console.log(`Added ${idsAdded} IDs during render, saving...`);
                saveMenuData();
            }
            
            let filteredItems = menuItems;

            // Apply category filter
            if (currentFilter !== 'all') {
                filteredItems = menuItems.filter(item => item.category === currentFilter);
            }

            // Apply search filter
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                const searchTerm = searchInput.value.toLowerCase();
                if (searchTerm) {
                    filteredItems = filteredItems.filter(item => 
                        item.name.toLowerCase().includes(searchTerm) ||
                        item.description.toLowerCase().includes(searchTerm)
                    );
                }
            }
            
            if (filteredItems.length === 0) {
                menuList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🍽️</div>
                        <p>No menu items found</p>
                        <p style="font-size: 0.8rem;">Try adjusting your search or filter criteria</p>
                    </div>
                `;
                return;
            }
            
            try {            menuList.innerHTML = filteredItems.map(item => {
                const isEightySixed = !isItemAvailableToday(item);
                const todayName = getTodayName();
                
                return `
                <div class="menu-item-card ${currentEditingItem && currentEditingItem.id === item.id ? 'selected' : ''} ${isEightySixed ? 'eighty-sixed' : ''}" onclick="editItem('${item.id}')">
                    <div class="item-header">
                        <span class="item-name">${item.emoji || '🍽️'} ${item.name}</span>
                        <span class="item-price">$${item.price.toFixed(2)}</span>
                    </div>
                    <div class="item-description">${item.description || 'No description'}</div>
                    <div style="margin-bottom: 1rem;">
                        <span style="background: #f1f5f9; padding: 0.25rem 0.5rem; font-size: 0.8rem; border-radius: 4px;">${getCategoryName(item.category)}</span>
                        <span style="background: ${isEightySixed ? '#fef2f2' : '#f0fdf4'}; color: ${isEightySixed ? '#dc2626' : '#059669'}; padding: 0.25rem 0.5rem; font-size: 0.8rem; border-radius: 4px; margin-left: 0.5rem;">
                            ${isEightySixed ? `86'd (${todayName})` : 'Available'}
                        </span>
                    </div>
                    <div class="item-actions">
                        <button class="item-btn eighty-six ${isEightySixed ? 'active' : ''}" onclick="event.stopPropagation(); toggleEightySix('${item.id}')">
                            ${isEightySixed ? 'Un-86' : '86'}
                        </button>
                        <button class="item-btn edit" onclick="event.stopPropagation(); editItem('${item.id}')">Edit</button>
                        <button class="item-btn" onclick="event.stopPropagation(); duplicateItem('${item.id}')">Duplicate</button>
                        <button class="item-btn delete" onclick="event.stopPropagation(); deleteItem('${item.id}')">Delete</button>
                    </div>                </div>
            `}).join('');
            
            updateEightySixStats();
            
            } catch (error) {
                console.error('Error rendering menu items:', error);
                menuList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">⚠️</div>
                        <p>Error loading menu items</p>
                        <p style="font-size: 0.8rem;">Check console for details</p>
                    </div>
                `;
            }
        }

        // Get category display name
        function getCategoryName(category) {
            const categoryNames = {
                'appetizers': 'Appetizers',
                'mains': 'Main Courses',
                'desserts': 'Desserts',
                'beverages': 'Beverages'
            };
            return categoryNames[category] || category;
        }

        // Update the 86'd stats and total count
        function updateEightySixStats() {
            const totalItems = menuItems.length;
            const eightySixedToday = menuItems.filter(item => !isItemAvailableToday(item)).length;
            const availableToday = totalItems - eightySixedToday;
            
            // Update all stat counts
            document.getElementById('totalCount').textContent = totalItems;
            document.getElementById('eightySixedCount').textContent = eightySixedToday;
            document.getElementById('availableCount').textContent = availableToday;
            
            console.log(`Stats updated: ${totalItems} total items, ${availableToday} available, ${eightySixedToday} 86'd today`);
        }

        // Initialize day availability controls
        function initializeDayAvailability() {
            // Set all days as available by default
            document.querySelectorAll('.day-toggle').forEach(toggle => {
                toggle.classList.remove('disabled');
            });
        }

        // Get today's day name
        function getTodayName() {
            const today = new Date();
            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            return dayNames[today.getDay()];
        }

        // Check if an item is available today
        function isItemAvailableToday(item) {
            if (!item.dayAvailability) {
                return true; // If no day availability set, assume available
            }
            const today = getTodayName();
            return item.dayAvailability[today] !== false;
        }

        // Toggle day availability for editing item
        function toggleDayAvailability(day) {
            const toggle = document.querySelector(`[data-day="${day}"]`);
            if (toggle) {
                toggle.classList.toggle('disabled');
            }
        }

        // Toggle 86'd status for an item
        function toggleEightySix(itemId) {
            console.log('toggleEightySix called with ID:', itemId);
            const item = menuItems.find(i => i.id === itemId);
            if (!item) {
                console.error('Item not found with ID:', itemId);
                return;
            }

            console.log('Found item for 86:', item);
            const today = getTodayName();
            
            // Initialize dayAvailability if it doesn't exist
            if (!item.dayAvailability) {
                item.dayAvailability = {
                    monday: true,
                    tuesday: true,
                    wednesday: true,
                    thursday: true,
                    friday: true,
                    saturday: true,
                    sunday: true
                };
            }

            // Toggle today's availability
            item.dayAvailability[today] = !item.dayAvailability[today];
            
            saveMenuData();
            renderMenuItems();
            
            const status = item.dayAvailability[today] ? 'available' : '86\'d';
            showNotification(`${item.name} is now ${status} for today`);
        }

        // Show notification message
        function showNotification(message, type = 'success') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : '#ef4444'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 1000;
                font-size: 14px;
                max-width: 300px;
                word-wrap: break-word;
            `;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        // Initialize menu import functionality
        function initializeMenuImport() {
            const importInput = document.getElementById('menuImportInput');
            if (importInput) {
                importInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            let importedData;
                            
                            if (file.name.endsWith('.json')) {
                                importedData = JSON.parse(event.target.result);
                            } else if (file.name.endsWith('.csv')) {
                                // Basic CSV parsing
                                const lines = event.target.result.split('\n');
                                const headers = lines[0].split(',').map(h => h.trim());
                                importedData = [];
                                
                                for (let i = 1; i < lines.length; i++) {
                                    if (lines[i].trim()) {
                                        const values = lines[i].split(',').map(v => v.trim());
                                        const item = {
                                            id: 'item_' + Date.now() + '_' + i,
                                            name: values[0] || 'Unnamed Item',
                                            price: parseFloat(values[1]) || 0,
                                            category: values[2] || 'mains',
                                            description: values[3] || '',
                                            emoji: values[4] || '🍽️',
                                            available: true,
                                            dayAvailability: {
                                                monday: true,
                                                tuesday: true,
                                                wednesday: true,
                                                thursday: true,
                                                friday: true,
                                                saturday: true,
                                                sunday: true
                                            }
                                        };
                                        importedData.push(item);
                                    }
                                }
                            }

                            if (importedData && Array.isArray(importedData)) {
                                // Merge or replace menu items
                                const shouldReplace = confirm('Replace existing menu items? Click Cancel to merge with existing items.');
                                
                                if (shouldReplace) {
                                    menuItems = importedData;
                                } else {
                                    menuItems = [...menuItems, ...importedData];
                                }
                                
                                saveMenuData();
                                renderMenuItems();
                                showNotification(`Successfully imported ${importedData.length} menu items!`);
                            } else {
                                showNotification('Invalid file format. Please use JSON or CSV.', 'error');
                            }
                        } catch (error) {
                            console.error('Import error:', error);
                            showNotification('Error importing file. Please check the format.', 'error');
                        }
                    };
                    
                    reader.readAsText(file);
                    // Reset the input so the same file can be selected again
                    e.target.value = '';
                });
            }
            console.log("Menu import functionality initialized");
        }

        // Filter items by category
        function filterByCategory(category) {
            currentFilter = category;
            
            // Update active button
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderMenuItems();
        }

        // Filter items by search term
        function filterItems() {
            renderMenuItems();
        }

        // Add new item
        function addNewItem() {
            currentEditingItem = null;
            clearForm();
            document.getElementById('editorTitle').textContent = 'Add New Item';
            document.getElementById('saveBtn').textContent = 'Save Item';
        }

        // Edit existing item
        function editItem(itemId) {
            console.log('editItem called with ID:', itemId);
            const item = menuItems.find(i => i.id === itemId);
            if (!item) {
                console.error('Item not found with ID:', itemId);
                return;
            }

            console.log('Found item:', item);
            currentEditingItem = item;
            
            // Populate form
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemPrice').value = item.price;
            document.getElementById('itemCategory').value = item.category;
            document.getElementById('itemDescription').value = item.description || '';
            document.getElementById('selectedEmoji').value = item.emoji || '🍽️';
            document.getElementById('itemAvailable').checked = item.available !== false; // Default to true
            
            // Update emoji selection UI
            document.querySelectorAll('.emoji-option').forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.emoji === item.emoji) {
                    option.classList.add('selected');
                }
            });
            
            // Update day toggle buttons
            if (item.dayAvailability) {
                document.querySelectorAll('.day-toggle').forEach(toggle => {
                    const day = toggle.dataset.day;
                    if (!item.dayAvailability[day]) {
                        toggle.classList.add('disabled');
                    } else {
                        toggle.classList.remove('disabled');
                    }
                });
            }
            
            // Update UI state
            document.getElementById('editorTitle').textContent = 'Edit Item';
            document.getElementById('saveBtn').textContent = 'Update Item';
            
            renderMenuItems(); // Re-render to show selection
        }

        // Duplicate item
        function duplicateItem(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;

            const newItem = {
                ...item,
                id: generateUniqueId(),
                name: item.name + ' (Copy)'
            };

            menuItems.push(newItem);
            saveMenuData();
            renderMenuItems();
            showNotification(`${item.name} duplicated successfully!`);
        }

        // Delete item
        function deleteItem(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;

            if (confirm(`Are you sure you want to delete "${item.name}"? This cannot be undone.`)) {
                menuItems = menuItems.filter(i => i.id !== itemId);
                saveMenuData();
                renderMenuItems();
                
                // Clear form if we were editing this item
                if (currentEditingItem && currentEditingItem.id === itemId) {
                    currentEditingItem = null;
                    clearForm();
                }
                
                showNotification(`${item.name} deleted successfully!`, 'warning');
            }
        }

        // Select emoji
        function selectEmoji(emoji) {
            document.getElementById('selectedEmoji').value = emoji;
            
            // Update visual selection
            document.querySelectorAll('.emoji-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }

        // Clear form
        function clearForm() {
            document.getElementById('itemForm').reset();
            document.getElementById('selectedEmoji').value = '';
            document.querySelectorAll('.emoji-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Reset day availability to all available
            document.querySelectorAll('.day-toggle').forEach(toggle => {
                toggle.classList.remove('disabled');
            });
            
            currentEditingItem = null;
            document.getElementById('editorTitle').textContent = 'Add New Item';
            document.getElementById('saveBtn').textContent = 'Save Item';
        }

        // Save all changes and sync with POS
        function saveAllChanges() {
            saveMenuData();
            showNotification('All changes saved successfully!');
        }

        // Export menu function
        function exportMenu() {
            const dataStr = JSON.stringify(menuItems, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'menu-export.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('Menu exported successfully!');
        }

        // Handle form submission
        document.getElementById('itemForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get day availability
            const dayAvailability = {};
            document.querySelectorAll('.day-toggle').forEach(toggle => {
                const day = toggle.dataset.day;
                dayAvailability[day] = !toggle.classList.contains('disabled');
            });
            
            const formData = {
                id: currentEditingItem ? currentEditingItem.id : generateUniqueId(),
                name: document.getElementById('itemName').value,
                price: parseFloat(document.getElementById('itemPrice').value),
                category: document.getElementById('itemCategory').value,
                description: document.getElementById('itemDescription').value,
                emoji: document.getElementById('selectedEmoji').value || '🍽️',
                available: document.getElementById('itemAvailable').checked,
                dayAvailability: dayAvailability,
                modifiers: currentEditingItem ? currentEditingItem.modifiers || [] : []
            };

            // Validation
            if (!formData.name || !formData.price || !formData.category) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            if (currentEditingItem) {
                // Update existing item
                const index = menuItems.findIndex(item => item.id === currentEditingItem.id);
                if (index !== -1) {
                    menuItems[index] = formData;
                }
                showNotification(`${formData.name} updated successfully!`);
            } else {
                // Add new item
                menuItems.push(formData);
                showNotification(`${formData.name} added successfully!`);
            }

            saveMenuData();
            renderMenuItems();
            clearForm();
        });

        // Toggle bulk 86'd status
        function toggleBulkEightySix() {
            const today = getTodayName();
            const allItems86d = menuItems.every(item => !isItemAvailableToday(item));
            
            menuItems.forEach(item => {
                // Initialize dayAvailability if it doesn't exist
                if (!item.dayAvailability) {
                    item.dayAvailability = {
                        monday: true,
                        tuesday: true,
                        wednesday: true,
                        thursday: true,
                        friday: true,
                        saturday: true,
                        sunday: true
                    };
                }
                
                // If all items are 86'd, make them all available. Otherwise, 86 them all
                item.dayAvailability[today] = allItems86d;
            });
            
            saveMenuData();
            renderMenuItems();
            
            const status = allItems86d ? 'available' : '86\'d';
            showNotification(`All items are now ${status} for today`);
        }

        // Modifier functions
        let currentModifiers = [];
        
        function showModifiersPanel() {
            // Initialize modifiers from current editing item or empty array
            if (currentEditingItem && currentEditingItem.modifiers) {
                currentModifiers = JSON.parse(JSON.stringify(currentEditingItem.modifiers));
            } else {
                currentModifiers = [];
            }
            
            renderModifierGroups();
            document.getElementById('modifiersModal').style.display = 'flex';
        }

        function closeModifiersPanel() {
            document.getElementById('modifiersModal').style.display = 'none';
        }

        function saveModifiers() {
            // Save modifiers to current editing item
            if (currentEditingItem) {
                currentEditingItem.modifiers = JSON.parse(JSON.stringify(currentModifiers));
            }
            
            closeModifiersPanel();
            showNotification('Modifiers saved successfully!');
        }

        function addModifierGroup() {
            const newGroup = {
                id: 'group_' + Date.now(),
                name: 'New Modifier Group',
                type: 'single', // single or multi selection
                options: []
            };
            
            currentModifiers.push(newGroup);
            renderModifierGroups();
        }
        
        function renderModifierGroups() {
            const container = document.getElementById('modifierGroupsContainer');
            if (!container) return;
            
            if (currentModifiers.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #6b7280;">
                        <p>No modifier groups yet. Click "Add Modifier Group" to get started.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = currentModifiers.map((group, groupIndex) => `
                <div class="modifiers-group" data-group-index="${groupIndex}">
                    <div class="modifiers-group-header">
                        <input type="text" value="${group.name}" 
                               onchange="updateGroupName(${groupIndex}, this.value)"
                               style="border: none; background: transparent; font-weight: 600; font-size: 1rem; width: 200px;">
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <select onchange="updateGroupType(${groupIndex}, this.value)" style="padding: 0.25rem; font-size: 0.8rem;">
                                <option value="single" ${group.type === 'single' ? 'selected' : ''}>Single Choice</option>
                                <option value="multi" ${group.type === 'multi' ? 'selected' : ''}>Multiple Choice</option>
                            </select>
                            <button class="modifier-remove-btn" onclick="removeModifierGroup(${groupIndex})" title="Delete Group">×</button>
                        </div>
                    </div>
                    <div class="modifier-options">
                        ${group.options.map((option, optionIndex) => `
                            <div class="modifier-option">
                                <div style="display: flex; gap: 0.5rem; align-items: center; flex: 1;">
                                    <input type="text" value="${option.name || option}" 
                                           onchange="updateOptionName(${groupIndex}, ${optionIndex}, this.value)"
                                           placeholder="Option name" style="flex: 1; padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 4px;">
                                    <input type="number" value="${option.price || 0}" step="0.01"
                                           onchange="updateOptionPrice(${groupIndex}, ${optionIndex}, this.value)"
                                           placeholder="0.00" style="width: 80px; padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 4px;">
                                </div>
                                <button class="modifier-remove-btn" onclick="removeModifierOption(${groupIndex}, ${optionIndex})" title="Remove Option">×</button>
                            </div>
                        `).join('')}
                        <button class="modifier-add-btn" onclick="addModifierOption(${groupIndex})" title="Add Option">+</button>
                    </div>
                </div>
            `).join('');
        }
        
        function updateGroupName(groupIndex, newName) {
            if (currentModifiers[groupIndex]) {
                currentModifiers[groupIndex].name = newName;
            }
        }
        
        function updateGroupType(groupIndex, newType) {
            if (currentModifiers[groupIndex]) {
                currentModifiers[groupIndex].type = newType;
            }
        }
        
        function removeModifierGroup(groupIndex) {
            if (confirm('Are you sure you want to delete this modifier group?')) {
                currentModifiers.splice(groupIndex, 1);
                renderModifierGroups();
            }
        }
        
        function addModifierOption(groupIndex) {
            if (currentModifiers[groupIndex]) {
                currentModifiers[groupIndex].options.push({
                    name: 'New Option',
                    price: 0
                });
                renderModifierGroups();
            }
        }
        
        function updateOptionName(groupIndex, optionIndex, newName) {
            if (currentModifiers[groupIndex] && currentModifiers[groupIndex].options[optionIndex]) {
                if (typeof currentModifiers[groupIndex].options[optionIndex] === 'string') {
                    currentModifiers[groupIndex].options[optionIndex] = { name: newName, price: 0 };
                } else {
                    currentModifiers[groupIndex].options[optionIndex].name = newName;
                }
            }
        }
        
        function updateOptionPrice(groupIndex, optionIndex, newPrice) {
            if (currentModifiers[groupIndex] && currentModifiers[groupIndex].options[optionIndex]) {
                if (typeof currentModifiers[groupIndex].options[optionIndex] === 'string') {
                    currentModifiers[groupIndex].options[optionIndex] = { 
                        name: currentModifiers[groupIndex].options[optionIndex], 
                        price: parseFloat(newPrice) || 0 
                    };
                } else {
                    currentModifiers[groupIndex].options[optionIndex].price = parseFloat(newPrice) || 0;
                }
            }
        }
        
        function removeModifierOption(groupIndex, optionIndex) {
            if (currentModifiers[groupIndex] && currentModifiers[groupIndex].options[optionIndex]) {
                currentModifiers[groupIndex].options.splice(optionIndex, 1);
                renderModifierGroups();
            }
        }

        // Update cloud status indicator
        function updateCloudStatus(status, message) {
            const statusElement = document.getElementById('cloudStatus');
            const iconElement = document.getElementById('cloudStatusIcon');
            const textElement = document.getElementById('cloudStatusText');
            
            if (!statusElement || !iconElement || !textElement) return;
            
            // Remove all status classes
            statusElement.classList.remove('connected', 'offline', 'error');
            
            switch (status) {
                case 'connected':
                    statusElement.classList.add('connected');
                    iconElement.textContent = '☁️';
                    textElement.textContent = message || 'Cloud Connected';
                    break;
                case 'offline':
                    statusElement.classList.add('offline');
                    iconElement.textContent = '📱';
                    textElement.textContent = message || 'Local Storage';
                    break;
                case 'error':
                    statusElement.classList.add('error');
                    iconElement.textContent = '⚠️';
                    textElement.textContent = message || 'Connection Error';
                    break;
                default:
                    iconElement.textContent = '🔄';
                    textElement.textContent = message || 'Connecting...';
            }
        }

        // Check Firebase connection status
        async function checkFirebaseConnection() {
            try {
                if (!window.firebaseServices) {
                    updateCloudStatus('offline', 'Firebase not available');
                    return false;
                }

                const db = window.firebaseServices.getDb();
                if (!db) {
                    updateCloudStatus('offline', 'Database not available');
                    return false;
                }

                // Get current business context from multiple sources
                let currentBusiness = null;
                let businessSource = 'none';

                // 1. Try umbrella manager first
                if (window.umbrellaManager && window.umbrellaManager.currentBusiness) {
                    currentBusiness = window.umbrellaManager.currentBusiness;
                    businessSource = 'umbrella_manager';
                }

                // 2. Try super admin business context
                if (!currentBusiness && window.SuperAdminManager) {
                    const superAdminContext = window.SuperAdminManager.getCurrentBusinessContext();
                    if (superAdminContext && superAdminContext.businessID) {
                        currentBusiness = {
                            id: superAdminContext.businessID,
                            companyName: superAdminContext.companyName || 'Super Admin Business'
                        };
                        businessSource = 'super_admin';
                    }
                }

                // 3. Try localStorage business context  
                if (!currentBusiness) {
                    const storedContext = localStorage.getItem('currentBusinessContext');
                    if (storedContext) {
                        try {
                            const contextData = JSON.parse(storedContext);
                            if (contextData.businessID || contextData.id) {
                                currentBusiness = {
                                    id: contextData.businessID || contextData.id,
                                    companyName: contextData.companyName || contextData.businessName || 'Current Business'
                                };
                                businessSource = 'localStorage';
                            }
                        } catch (e) {
                            console.warn('Failed to parse business context from localStorage');
                        }
                    }
                }

                if (!currentBusiness || !currentBusiness.id) {
                    // Firebase is available but no business context
                    updateCloudStatus('offline', 'No business selected');
                    return false;
                }

                // Test connection with a simple read
                await db.collection('businesses').doc(currentBusiness.id).get();
                updateCloudStatus('connected', `Connected to ${currentBusiness.companyName || 'Cloud'} (${businessSource})`);
                return true;
                
            } catch (error) {
                console.error('Firebase connection check failed:', error);
                updateCloudStatus('error', 'Connection failed');
                return false;
            }
        }

        // Make functions globally accessible for onclick handlers
        window.editItem = editItem;
        window.toggleEightySix = toggleEightySix;
        window.duplicateItem = duplicateItem;
        window.deleteItem = deleteItem;
        window.selectEmoji = selectEmoji;
        window.filterByCategory = filterByCategory;
        window.filterItems = filterItems;
        window.addNewItem = addNewItem;
        window.clearForm = clearForm;
        window.saveAllChanges = saveAllChanges;
        window.exportMenu = exportMenu;
        window.toggleBulkEightySix = toggleBulkEightySix;
        window.showModifiersPanel = showModifiersPanel;
        window.closeModifiersPanel = closeModifiersPanel;
        window.saveModifiers = saveModifiers;
        window.addModifierGroup = addModifierGroup;
        window.toggleDayAvailability = toggleDayAvailability;
    </script>
</body>
</html>
